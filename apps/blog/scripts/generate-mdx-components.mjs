import { readdir, writeFile } from "node:fs/promises";
import path from "node:path";

const toPascalCase = (value) =>
  value
    .split(/[-_]/g)
    .filter(Boolean)
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join("");

const isComponentFile = (file) => {
  if (!file.endsWith(".ts") && !file.endsWith(".tsx")) return false;
  if (file.endsWith(".test.ts") || file.endsWith(".test.tsx")) return false;
  if (file.endsWith(".spec.ts") || file.endsWith(".spec.tsx")) return false;
  if (file === "index.ts" || file === "index.tsx") return false;
  if (file.startsWith("_")) return false;
  return true;
};

const appRoot = process.cwd();
const widgetsDir = path.join(appRoot, "src/widgets/mdx");
const outputFile = path.join(appRoot, "src/shared/lib/mdx-widgets.generated.ts");

let files = [];
try {
  files = (await readdir(widgetsDir, { withFileTypes: false })).filter(
    isComponentFile,
  );
} catch {
  files = [];
}

const entries = files
  .map((file) => {
    const ext = path.extname(file);
    const fileBase = file.slice(0, -ext.length);
    const componentName = toPascalCase(fileBase);
    return { file, fileBase, componentName };
  })
  .sort((a, b) => a.componentName.localeCompare(b.componentName));

const names = new Set();
for (const entry of entries) {
  if (!/^[A-Z][A-Za-z0-9]*$/.test(entry.componentName)) {
    throw new Error(
      `Invalid MDX component name "${entry.componentName}" from file "${entry.file}". Rename the file to something like "MdxSomething.tsx".`,
    );
  }
  if (names.has(entry.componentName)) {
    throw new Error(
      `Duplicate MDX component name "${entry.componentName}". Check files under src/widgets/mdx.`,
    );
  }
  names.add(entry.componentName);
}

const importLines = entries.map(
  ({ componentName, fileBase }) =>
    `import ${componentName} from \"@/widgets/mdx/${fileBase}\";`,
);
const objectLines = entries.map(({ componentName }) => `  ${componentName},`);

const output = `/* eslint-disable */
// This file is auto-generated by scripts/generate-mdx-components.mjs.
// Do not edit by hand.

${importLines.join("\n")}

export const mdxWidgetComponents = {
${objectLines.join("\n")}
};
`;

await writeFile(outputFile, output, "utf8");
console.log(
  `Generated ${path.relative(appRoot, outputFile)} (${entries.length} components)`,
);

